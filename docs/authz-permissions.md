# Authorization Permissions

JWTs that are sent by Vault contain permissions for OPA to act on. This
document notes the details of the structure of the JWTs and other related
information.

- TODO: Vault: Name the auth mount backend better than "jwt". 
- TODO: Vault: Possibly, use to which client it is "Bound". See "Bound issuer".
- TODO: Vault: give better name to "test-role"
- TODO: Vault: Set Jwks URL in Vault JWT auth settings
- TODO: Vault: Set Jwks CA PEM to fetch the Jwks URL in Vault JWT auth settings
- TODO: Vault set proper client IDs `"allowed_client_ids": ["cq_candig"]`
- TODO: Nested templates can be done, but not nested metadata in Vault
- TODO: Vault: set proper `allowed_client_ids` list for downstream `aud`
- TODO: Ask Ksenia for the final CanDIG model
- TODO: Perform checks on Vault tokens (OPA)

## JWT at a glance - the end goal?

We are not sure yet if our structure will be absolutely identical to ga4gh.

- `iss`: Issuer 
- `iat`: Issued time
- `exp`: Expiration time
- `jti`: Token ID
- `sub`: Suject ID (TODO: how to link to IdP's ID)
- `ga4gh_passport_v1`: List of the visas, could easily just be one item
  for now but the idea is to use GA4GH terminology. Child `ga4gh_visa_v1`.
  - `ga4gh_visa_v1`: a JWT with items
    - `type`: Either of these (there are more but we need these)
      - `LinkedIdentities`: [LinkedIdentities, GA4GH]
      - `ControlledAccessGrants`: [ControlledAccessGrants, GA4GH]
    - `value`: A string that represents any of the scope,
      process, identifier and version of the assertion. The format of
      the string can vary by the Passport Visa Type.
      For CanDIG, we perhaps need the value to be the dataset ID and
      level of the access. (TODO: data spec from Ksenia will help)
    - `source`: A URL Field that provides at a minimum the
      organization that made the assertion. If there is no organization making
      the assertion, the "source" MUST be set to "https://no.organization".
    - `asserted`: time at assertion
    - `by`; [by field, GA4GH] (TODO: specify who? self? dac?)
    - `iss`: 
    - `sub`:
    - `iat`:
    - `exp`:


## Draft v003

The most basic version with only dataset level permissions.

### Data model at the time of this writing

- Project top level has
  - One or more Datasets
    - One or more Phenopackets (+ some extra data)
      - One or more Patients

```json
{
  "aud": "cq_candig",
  "exp": 1603988812,
  "iat": 1603902412,
  "iss": "/v1/identity/oidc",
  
  "ga4gh_passport_v1": {
    "ga4gh_visa_v1": {
      "type": "ControlledAccessGrants",
      "value": {
        "dataset1234": {
          "level": 4
        }
      }
    }
  },

  "sub": "b6a4b63c...9a7a247db34f"
}
```

## Draft v002

Includes basics of v001 but untroduces association with GA4GH.

- Not using JWT within a JWT structure
- `value` is not a string (as a result)
- `level` is for the entire database unless `entities` is listed
- `entities` is a list of URI spec'd strings where
  - `namespace` is a specific table or schema or version
  - uri paths can contain wild cards


```json
{
  "aud": "cq_candig",
  "exp": 1603988812,
  "iat": 1603902412,
  "iss": "/v1/identity/oidc",
  "namespace": "root",
  
  "ga4gh_passport_v1": {
    "ga4gh_visa_v1": {
      "type": "ControlledAccessGrants",
      "value": {
        "dataset1234": {
          "level": 4,
          "entities": [
            "namespace://path/to/entity1",
            "namespace2://path/to/entity2/*"
          ]
        }
      }
    }
  },

  "sub": "b6a4b63c...9a7a247db34f"
}
```

## Draft v001

Trying to keep things minimal for the first draft we will focus on a few
options -

1. Core JWT claims (fields) that are important security wise
2. Reduced focus on row/column level permissions

The payload may look like -

```json
{
  "aud": "cq_candig",  // set by `allowed_client_ids`
  "exp": 1603988812,
  "iat": 1603902412,
  "iss": "/v1/identity/oidc",
  "namespace": "root",
  "permissions": { //depends on Vault Role template
    "dataset123": "4"
  },
  "sub": "b6a4b63c...9a7a247db34f"  //Entity ID in Vault (requester)
}
```

### Template

The following part depends on the role's template -

```json
"permissions": {
    "dataset123": "4"
},
```

The template for that role could look like -

```json
{
    "key": "test-key",
    "client_id": "cq_candig",
    "template": "{\"permissions\": {{identity.entity.metadata}}}"
}
```

This tells Vault to fetch all the key-values in metadata
field of the entity.

### Audience `aud`

The `aud` claim is set by the command which creates the `key`

```json
vault write identity/oidc/key/test-key -<<EOF
{
    "rotation_period": "24h",
    "allowed_client_ids": ["cq_candig"]
}
EOF
```

This is where we can perhaps allow more names for downstream
service names for which this JWT from Vault is intended.

### Subject

The `sub` claim has the ID of the entity as saved by Vault.
This is likely autogenerated and unique within a Vault instance.

## References

- GA4GH Passport V1: https://github.com/ga4gh-duri/ga4gh-duri.github.io/blob/master/researcher_ids/ga4gh_passport_v1.md#by
- Vault Identity: https://www.vaultproject.io/docs/secrets/identity




[LinkedIdentities, GA4GH]: https://github.com/ga4gh-duri/ga4gh-duri.github.io/blob/master/researcher_ids/ga4gh_passport_v1.md#linkedidentities
[ControlledAccessGrants, GA4GH]: https://github.com/ga4gh-duri/ga4gh-duri.github.io/blob/master/researcher_ids/ga4gh_passport_v1.md#controlledaccessgrants
[by field, GA4GH]: https://github.com/ga4gh-duri/ga4gh-duri.github.io/blob/master/researcher_ids/ga4gh_passport_v1.md#by
