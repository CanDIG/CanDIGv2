version: '3.7'

services:
  jade-data-repo:
    image: gcr.io/broad-jade-dev/jade-data-repo
    ports:
      - "${DRS_PORT:-8085}:8080"
    networks:
      - ${DOCKER_NET:-bridge-net}
      - ${DRS_NET:-drs-net}
    deploy:
      placement:
        constraints:
          - node.role == worker
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
        window: 120s
      labels:
        - traefik.enable=true
        - traefik.port=${DRS_PORT:-8080}
        - traefik.docker.network=${DOCKER_NET:-bridge-net}
        - traefik.frontend.rule=Host:drs.${MINIO_DOMAIN:-localhost}

  jade-drs-postgresql:
    image: candig/postgres-drs
    build:
      context: $PWD/lib/jade-data-repo
      dockerfile: Dockerfile.database
    networks:
      - ${DRS_NET:-drs-net}
    volumes:
      - drs-data:/var/lib/postgres/data
    deploy:
      placement:
        constraints:
          - node.role == worker
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
        window: 120s
