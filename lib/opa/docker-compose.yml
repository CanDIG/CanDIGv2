version: '3.7'

services:
  opa:
    container_name: opa
    image: openpolicyagent/opa:${OPA_VERSION}
    volumes:
      # TODO: temp solution
      - ./data:/data
      - ./policy.rego:/policy.rego
      #- $PWD/lib/opa/opa_service:/data
    networks:
      - ${DOCKER_NET}
    ports:
      - "${OPA_PORT}:8181"
    command:
      - "run"
      - "--server"
      - "--log-level=${OPA_LOG_LEVEL}"
      - "/policy.rego"
    # deploy:
    #   placement:
    #     constraints:
    #       - node.role == worker
    #   restart_policy:
    #     condition: on-failure
    #     delay: 5s
    #     max_attempts: 3
    #     window: 120s
    #   labels:
    #     - traefik.enable=true
    #     - traefik.port=${OPA_PORT}
    #     - traefik.docker.network=${DOCKER_NET}
    #     - traefik.frontend.rule=Host:opa.${CANDIG_DOMAIN}
    # logging:
    #   driver: "fluentd"
    #   options:
    #     tag: docker.{{.Name}}
    #     fluentd-async-connect: "true"
    # command: ["run", "--server", "/data/metadata-service.json", "/data/metadata-service.rego"]
    # healthcheck:
    #   test: ["CMD", "curl", "-f", "http://localhost:8181/health"]
    #   interval: 30s
    #   timeout: 20s
    #   retries: 3

networks:
  bridge-net:
    external: true