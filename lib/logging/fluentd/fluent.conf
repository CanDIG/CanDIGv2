<source>
  @type forward
  @id input1
  @label @mainstream
  port 24224
  bind 0.0.0.0
</source>

<filter **>
  @type stdout
</filter>

<label @mainstream>
  <filter docker.candigv2_graphql_1>
    @type concat
    key log
    multiline_start_regexp /^GraphQL.*/
    flush_interval 1s
    timeout_label @OUTPUT
  </filter>
  <filter docker.candigv2_graphql_1>
    @type concat
    key log
    multiline_start_regexp /^INFO:\s{5}\(.*\)\s-\s\"WebSocket\s\/\"\s403/
    multiline_end_regexp /^INFO:.*connection closed/
    flush_interval 1s
    timeout_label @OUTPUT
  </filter>
  <filter **>
    @type grep
    <exclude>
      key log
      pattern /^$/
    </exclude>
    flush_interval 1s
    timeout_label @OUTPUT
  </filter>
  <match **>
    @type relabel
    @label @OUTPUT
  </match>
</label>

<label @OUTPUT>
  <match **>
    @type elasticsearch
    @id output_fluentd
    host elasticsearch
    port 9200
    logstash_format true
    logstash_prefix fluentd
    logstash_dateformat %Y.%m.%d
    time_key_format %Y-%m-%dT%H:%M:%S.%N%z
    utc_index false
    include_tag_key true
    tag_key @log_name
    flush_interval 1s
    template_overwrite true
  </match>
</label>
